# Jira Issue Embedding Database Specification

## Overview

This specification defines a Jira Issue Embedding Database module that integrates with OpenSearch to store Jira issues with their embeddings and enable similarity search/correlation with error logs.

- Embeddings are generated by `EmbeddingService`.
- OpenSearch uses kNN with inner product on unit vectors (cosine-equivalent).
- Correlation of error logs currently writes a Jira reference back to logs; maintaining `occurrence_list` in the embedding index is optional and not active in the current code path.

## Index

- Current index name is provided by `JiraIssueEmbeddingDB.get_current_index_name()` (single index template from config).
- All vectors MUST be unit vectors before indexing and querying.

## Document Structure

```json
{
  "key": "string",
  "embedding": [float],
  "occurrence_list": [
    { "doc_id": "string", "timestamp": "string" }
  ],
  "summary": "string",
  "description": "string",
  "status": "string",
  "error_message": "string",
  "error_type": "string",
  "traceback": "string",
  "site": "string",
  "request_id": "string",
  "log_group": "string",
  "count": "integer|null",
  "created": "string",
  "updated": "string",
  "parent_issue_key": "string|null",
  "is_parent": "boolean",
  "not_commit_to_jira": "boolean",
  "created_at": "string",
  "updated_at": "string"
}
```

## Index Mapping (current)

```json
{
  "mappings": {
    "properties": {
      "key": { "type": "keyword" },
      "embedding": {
        "type": "knn_vector",
        "dimension": 1536,
        "method": {
          "name": "hnsw",
          "space_type": "innerproduct",
          "engine": "faiss",
          "parameters": { "ef_construction": 128, "m": 32 }
        }
      },
      "occurrence_list": {
        "type": "nested",
        "properties": {
          "doc_id": { "type": "keyword" },
          "timestamp": { "type": "date", "format": "strict_date_optional_time||epoch_millis" }
        }
      },
      "summary": { "type": "text", "fields": { "keyword": { "type": "keyword" } } },
      "description": { "type": "text" },
      "status": { "type": "keyword" },
      "error_message": { "type": "text", "fields": { "keyword": { "type": "keyword" } } },
      "error_type": { "type": "text", "fields": { "keyword": { "type": "keyword" } } },
      "traceback": { "type": "text", "fields": { "keyword": { "type": "keyword" } } },
      "site": { "type": "keyword" },
      "request_id": { "type": "keyword" },
      "log_group": { "type": "keyword" },
      "count": { "type": "integer" },
      "parent_issue_key": { "type": "keyword" },
      "is_parent": { "type": "boolean" },
      "not_commit_to_jira": { "type": "boolean" },
      "created": { "type": "date", "format": "strict_date_optional_time||epoch_millis" },
      "updated": { "type": "date", "format": "strict_date_optional_time||epoch_millis" },
      "created_at": { "type": "date", "format": "strict_date_optional_time||epoch_millis" },
      "updated_at": { "type": "date", "format": "strict_date_optional_time||epoch_millis" }
    }
  },
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 0,
    "index.knn": true,
    "index.knn.algo_param.ef_search": 100,
    "index.knn.algo_param.ef_construction": 128,
    "index.knn.algo_param.m": 16
  }
}
```

## Operational Workflows

### Initialization
1. Fetch Jira issues.
2. Generate embeddings via `EmbeddingService`, validate unit vectors, index documents.

### Daily/Periodic Sync
- Ingest new error logs, generate embeddings, search for similar Jira issues.
- If matched, update error logs with `jira_reference` to the embedding doc id.
- `occurrence_list` maintenance is optional and currently paused in code.

## Integration Notes

- Embedding generation and normalization performed by `EmbeddingService`.
- All query vectors must be validated/normalized to unit vectors before search.
- kNN search uses inner product; cosine equivalence relies on unit vectors.

## Custom Fields

- Custom Jira fields are mapped dynamically; values are stored as readable fields (e.g., `error_message`, `error_type`, `traceback`, etc.).

## Performance Considerations

- Unit vectors enable performant inner-product search with cosine-equivalent scoring.
- Use provided HNSW parameters (`m`, `ef_construction`, `ef_search`) per current mapping.

## Current Limitations / TODO

- `occurrence_list` is not actively updated; correlation is tracked in error logs by `jira_reference`.
- Year-based index rotation is not enabled; a single index template is used.
